name: CI Test
run-name: CI TEST

on:
  push:
    branches:
      - feature/ci-test
    paths:
      - "package.json"
env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
  GH_USER: "github-actions[bot]"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check-diff-version.outputs.is_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"
          cache: "yarn"

      - name: Set Github user informations.
        run: |
          git config --local user.email "${{ env.GH_EMAIL }}"
          git config --local user.name "${{ env.GH_USER }}"

      - name: Check the version
        id: check-diff-version
        run: |
          DIFF_COUNT="$(git diff HEAD HEAD^ --relative package.json |grep '"version":'|wc -l)"
          if [ ${DIFF_COUNT} -eq 2 ]; then
            echo "is_release=true" >>"${GITHUB_OUTPUT}"
          else
            echo "is_release=false" >>"${GITHUB_OUTPUT}"
          fi

  job1:
    needs:
      - prepare
    if: ${{ needs.prepare.outputs.is_release  }}
    runs-on: ubuntu-latest
    steps:
      - name: Release
        run: echo "START-RELEASE"
  job2:
    needs:
      - job1
    runs-on: ubuntu-latest
    steps:
      - name: Publish
        run: echo "START-Publish"
